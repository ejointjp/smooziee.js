---
layout: page
title: somooziee.jsの仕組み
permalink: /structure/
template: 2-columns
---

<p>いくつかの特徴的な機能について、仕組みを簡単に説明します。</p>

<h2>他ページへのリンクでスムーススクロールを行う仕組み</h2>

<p>ハッシュタグ付きの別ページへのリンクをクリックした場合、通常はスクロールさせる前に、そのidがついた要素の部分が表示されてしまいます。ですので、それを回避し、ページの最上部が表示された後に該当箇所へスクロールさせる方法が必要となります。</p>
<p>この方法として、ハッシュタグ付きの別ページへのリンクをクリックした場合、ハッシュタグ（例えば <code>#link</code> ）</p>を <code>?scroll_id=link</code> に変換します。</p>
<p>例えば、リンクのhrefが <code>/dir/page.html#link</code> なら、 <code>/dir/page.html?page_id=link</code> に変換してリクエストを送ります。</p>
<p>その後、idが <code>link</code> の要素を探し、その部分までスクロールをさせる、といった流れで、他ページリンクのスクロールを実現しています。</p>
<p>また、もともとhrefにクエリパラメータが付いている場合も考慮されています。例えばhrefが <code>/dir/page.html?key=value#link</code> なら、 <code>/dir/page.html?key=value&amp;scroll_id=link</code> に変換されます。</p>


<h2>ページ内リンク、サイト内別ページリンク、別サイトリンクの判別方法</h2>

<p>ハッシュタグがつけられたaタグの <code>href</code> 属性を3種類に判別し、それぞれ動作を変更させています。</p>

<ul>
  <li>ページ内リンクである</li>
  <li>サイト内の別ページへのリンクである</li>
  <li>別サイトへのリンクである</li>
</ul>

<p>まず、ハッシュ（#）ではじまるリンクの場合、無条件でページ内スクロールを行います。</p>
<p>次に、ハッシュ以外ではじまるハッシュを含んだリンクについて、いくつかの判別を行います。まず、同サイトへのリンクか別サイトのリンクかの判別が行われます。</p>
<p>これは、URLのドメイン部分まで（<code>http://example.com</code> ）と、hrefのドメイン部分までが同一であるかどうかで判別します。jqueryの <code>prop('href')</code> で、アンカータグのhrefが相対パスの場合でも httpから取得することができます。</p>

<p>別サイトへのリンクの場合は、何も行わず終了します。同じサイト内のリンクの場合、次に、同じページへのリンクか、別のページへのリンクかを判別します。</p>

<p>同じページかどうかの判定は、</p>

<ul>
  <li>aタグのhrefプロパティ（http://...）のうちハッシュタグを除いたもの</li>
  <li>ページURLのうちハッシュタグおよびスクロールキー（scroll_id=）とその値を除いたもの</li>
</ul>

<p>が同一であることで判別しています。ですので、href属性の値が絶対パスでも相対パスでも、またクエリパラメータの有無に関わらず、正しく判定が行われます。</p>
<p>例えば、ページURLが <code>http://example.com/test/index2.html</code> の場合、aタグのhref属性が <code>#link</code> や <code>/test/index2.html#link</code>, <code>http://example.com/test/index2.html#link</code> ならページ内リンクと判定されます。</p>
<p>ただし、<code>index.html</code> の省略の有無が異なる場合は別ページと判定されます。URLが<code>http://example.com/test/</code> の場合、aタグのhref属性が<code>index.html#link</code> や <code>/test/index.html#link</code>, <code>http://example.com/test/index.html#link</code> の場合は別ページとして扱われます。</p>

<p>クエリパラメータが異なる場合も別ページとして扱われます。ただし、URLのスクロールキーとその値は判別に影響しません。</p>
<p>URLが <code>http://example.com/?scroll_id=test</code> の場合、 <code>http://example.com/#link</code> は同じページとして扱われ、ページ遷移のないスムーズスクロールが行われます。</p>

<p>同じページと判別された場合、通常のスムーススクロールを行います。別ページと判別された場合、リンク先URLを変換したのちにページ遷移し、その後スクロールが行われます。</p>


<h2>URL変更の仕組み</h2>

<p>スムーススクロールを実現するにあたり、通常 <code>event.preventDefault()</code> で初期動作を無効化するため、URLにハッシュタグが表示されません。</p>
<p>しかし、ページ内スクロールしたらちゃんとハッシュタグつけたい！という声もあるかと思います。そんなご要望にお応えして、{{ site.title }}では、スクロールされた後に、 <code>window.history.pushState</code> を使って、URLをハッシュタグ付きのURLに書き換えています。</p>
<p>また、他ページへのリンク時に <code>scroll_id=xx</code> が表示されたままなのもなんかアレだ。というわけで、この場合も、変換される前の元のハッシュタグに書き換えをします。一瞬、URLがページリダイレクトみたいな挙動を見せるのはそのためです。</p>
<p>URL書き換えは、設定によって無効にできます。また、従来のスムーススクロールのように、URLにハッシュタグがつかないようにすることもできます。</p>
