---
layout: page
title: somooziee.jsの仕組み
permalink: /structure/
template: 2-columns
---

<p>いくつかの特徴的な機能について、仕組みを簡単に説明します。</p>

<h2>別ページへのリンクでスムーススクロールを行う仕組み</h2>

<p>ハッシュタグ付きの別ページへのリンクをクリックした場合、通常は、jQueryでスクロールさせる前に、そのidがついた要素の部分へジャンプして表示されてしまいます。ですので、それを回避し、ページの最上部が表示された後に該当箇所へスクロールさせる手順が必要となります。</p>
<p>この実現方法として、ハッシュタグ付きの別ページへのリンクをクリックした場合、ハッシュタグ（例えば <code>#link</code> ）を <code>?scroll_id=link</code> に変換します。この変換は、条件に該当するリンクをクリックしたタイミングで行われます。</p>
<p>例えば、リンクのhrefが <code>page.html#link</code> なら、 <code>page.html?page_id=link</code> に変換してリクエストを送ります。この方法で、ページ遷移直後にid要素にジャンプすることを回避することができます。</p>
<p>その後、URL内の <code>page_id=link</code> をもとに、idが <code>link</code> の要素を探し、その部分までスクロールをさせる、といった流れで、他ページリンクのスクロールを実現しています。</p>
<p>また、もともとhrefに他のクエリパラメータが付いている場合も考慮されています。例えばhrefが <code>/dir/page.html?key=value#link</code> なら、 <code>/dir/page.html?key=value&amp;scroll_id=link</code> に変換されます。</p>


<h2>ページ内リンク、サイト内別ページリンク、別サイトリンクの判別方法</h2>

<p>ハッシュ（#）が含まれるリンクを3種類に判別し、それぞれ動作を変更させています。</p>

<ul>
  <li>ページ内リンクである</li>
  <li>サイト内の別ページへのリンクである</li>
  <li>別サイトへのリンクである</li>
</ul>

<p>まず、ハッシュ（#）ではじまるリンクの場合、無条件で通常のページ内スクロールを行います。</p>
<p>次に、ハッシュ以外ではじまるハッシュを含んだリンク（例えば <code>/dir/test.html#link</code> ）について、いくつかの判別を行います。</p>
<p>まず、リンクがサイト内へのリンクか別サイトへのリンクかの判定を行います。別サイトへのリンクの場合は、何も行いません。</p>
<p>同サイトへのリンクの場合、次にページ内リンクであるかどうかの判定を行います。</p>


<h3>「同じページへのリンクである」という判断基準</h3>

<p>「同じページへのリンクである」、つまりページ内リンクであることの基準は、ブラウザデフォルトの挙動に準じます。つまり、デフォルトの挙動でページ遷移（再読込）が行われないリンクの場合、「同じページ」と判断します。</p>
<p>以下は、同じページへのリンクの例です。</p>

<dl>
  <dt>ページURL: <code>http://example.com/test/index.html</code> の場合</dt>
  <dd>
    <ul>
      <li><code>#</code>（ページのトップへスクロール）</li>
      <li><code>#link</code></li>
      <li><code>/test/index.html#link</code></li>
      <li><code>http://example.com/test/index.html#link</code></li>
    </ul>
  </dd>
</dl>

<p><code>index.html</code> の省略の有無やクエリパラメータが異なる場合は、ブラウザデフォルトの挙動と同じく別ページと判定されます。</p>
<p>ただし、URLのスクロールキーとその値（<code>scroll_id=xxx</code> ）は判別に影響しません。</p>
<p>URLが <code>http://example.com/?scroll_id=test</code> の場合、 <code>http://example.com/#link</code> は同じページとして扱われ、ページ遷移のないスムーズスクロールが行われます。</p>

<p>同じページと判別された場合、通常のスムーススクロールを行います。別ページと判別された場合、リンク先URLを変換したのちにページ遷移し、その後スクロールが行われます。</p>


<h2>URL書き換えの仕組み</h2>

<p>スムーススクロールを実現するにあたり、通常 <code>event.preventDefault()</code> で初期動作を無効化するため、URLにハッシュタグが表示されません。</p>
<p>しかし、ページ内スクロールしたらちゃんとハッシュタグつけたい！という声もあるかと思います。そんなご要望にお応えして、{{ site.title }}では、スクロールされた後に、 <code>window.history.pushState</code> を使って、URLをハッシュタグ付きのURLに書き換えています。</p>
<p>また、他ページへのリンク時に <code>scroll_id=xx</code> が表示されたままなのもなんかアレだ。というわけで、この場合も、変換される前の元のハッシュタグに書き換えをします。一瞬、URLがページリダイレクトみたいな挙動を見せるのはそのためです。</p>
<p>URL書き換えは、設定によって無効にできます。また、従来のスムーススクロールのように、URLにハッシュタグがつかないようにすることもできます。</p>
